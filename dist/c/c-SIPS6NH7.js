import{B as k,E as re,b as c,c as w,d as A,e as O,r as ie,t as Z,u as oe,v as T,w as W,y as _}from"https://st-p.rmcdn.net/8e59565c/dist/c/c-5HIQDYWT.js";import{a as L,b as ee}from"https://st-p.rmcdn.net/8e59565c/dist/c/c-LBVH3I4Y.js";import{a as D,b as te}from"https://st-p.rmcdn.net/8e59565c/dist/c/c-WMOLK6Z3.js";import{m as C,o as F,s as Q}from"https://st-p.rmcdn.net/8e59565c/dist/c/c-A6M5PDNO.js";import{c as y,k as z,o as H}from"https://st-p.rmcdn.net/8e59565c/dist/c/c-3SL2HRH4.js";import{g as h,h as G,y as f,z as j}from"https://st-p.rmcdn.net/8e59565c/dist/c/c-GJ6KZY3F.js";import{h as x,l as v,m as b,n as E}from"https://st-p.rmcdn.net/8e59565c/dist/c/c-ICSWQCT7.js";import{a as M,b as K}from"https://st-p.rmcdn.net/8e59565c/dist/c/c-ZGXQUP27.js";import{a as u,f as p}from"https://st-p.rmcdn.net/8e59565c/dist/c/c-AUVFGGVF.js";var I,U=u(()=>{"use strict";te();w();H();I=class extends c{constructor(){super();p(this,"triggersState",{});p(this,"triggersElements",{})}bindTriggerElement(e,t){this.triggersElements[e]=this.detach(t),this.bindTriggerCallback(e)}bindTriggerCallback(e){let t=this.triggersState[e]||{},s=this.triggersElements[e];if(s)for(let r in t){let o=t[r];o&&(typeof o.unbind=="function"&&o.unbind(),o.unbind=z({element:s,events:o.events,callback:o.callback}))}}addTriggerCallback({responderWidgetId:e,triggerWidgetIds:t=[],events:s,callback:r}){let o=D();for(let a of t){let i=`${e}-${o}`;a in this.triggersState||(this.triggersState[a]={}),this.triggersState[a][i]={events:s,callback:r},this.bindTriggerCallback(a)}}isWidgetTrigger(e){return e in this.triggersState}}});var R,B=u(()=>{"use strict";j();w();ie();ee();R=class extends c{constructor(){super();p(this,"animations",{});p(this,"groupRects",{});p(this,"groupState",{})}getAnimationsGroups(e){let t={},s=G(Object.values(e).map(o=>o.animations).flat(),"UUID"),r=Object.entries(e);for(let[o,a]of r)for(let i of a.animations)s[i.UUID]>1&&(t[i.UUID]=[...t[i.UUID]||[],{widgetId:o,rect:a.rect}]);return t}getAnimationsGroupsRects(e){let t={},s=Object.keys(e);for(let r of s){let o=e[r].map(d=>{let J=this.animations[d.widgetId].transforms.rotation?.angle??0;return L.rotateBox(d.rect,J)}),a=Math.min(...o.map(d=>d.top)),i=Math.min(...o.map(d=>d.left)),n=Math.max(...o.map(d=>d.top+d.height)),l=Math.max(...o.map(d=>d.left+d.width))-i,$=n-a;t[r]={top:a,left:i,width:l,height:$}}return t}createGroupsState(e,t){let s={...e};for(let r in t){s[r]=s[r]||{};for(let o of t[r])o.widgetId in s[r]||(s[r][o.widgetId]=!1)}return s}addWidget({widgetId:e,animations:t,rect:s,rotation:r,flipY:o,flipX:a}){this.animations[e]={rect:s,animations:t,transforms:{flipX:a,flipY:o,rotation:A(r),invertedRotation:A((r||0)*-1)}};let i=this.getAnimationsGroups(this.animations),n=this.getAnimationsGroupsRects(i),g=this.createGroupsState(this.groupState,i);this.groupRects=n,this.groupState=g}getAnimationsGroupRect(e){return e in this.groupRects?this.groupRects[e]:null}getAnimationsGroupOrigin(e,t){if(e in this.groupRects&&t in this.animations){let s=this.animations[t],r=s.transforms,o=s.rect,a=this.groupRects[e],i={x:o.left-a.left,y:o.top-a.top},n={x:a.width/2,y:a.height/2},g={x:n.x-i.x,y:n.y-i.y},l=O({rotation:r.invertedRotation,point:g,origin:{...o,left:0,top:0}});return r.flipX&&(l.x=o.width-l.x),r.flipY&&(l.y=o.height-l.y),l}return null}getGroupState(e){return e in this.groupState?Object.values(this.groupState[e]).some(Boolean):null}updateGroupState(e,t,s,r=!1){if(e in this.groupState)if(this.groupState[e]=this.groupState[e]||{},r)for(let o in this.groupState[e])this.groupState[e][o]=s;else this.groupState[e][t]=s}getAnimationsWidgetRect(e){return this.animations[e]?.rect||null}}});var S,N=u(()=>{"use strict";w();S=class extends c{constructor(){super();p(this,"zIndexes",{})}init(e){for(let t of e)typeof t.model.z=="number"&&this.setZIndex(t.model._id,t.model.z),t.subscribe("model.z",()=>{typeof t.model.z=="number"&&this.setZIndex(t.model._id,t.model.z)})}getTopmostZIndex(){return Math.max(...Object.values(this.zIndexes))}setZIndex(e,t){typeof t=="number"&&this.zIndexes[e]!==t&&(this.zIndexes[e]=t)}}});var q,V,X=u(()=>{"use strict";w();E();K();_();_();q={pageId:"",scale:1,zoom:1,transform:1,num:0,availableViewports:[],currentViewport:"default",hasTabletViewport:!1,hasPhoneViewport:!1,screenshot:"",desktopPageHeight:0,tabletPageHeight:0,phonePageHeight:0},V=class extends c{constructor(e){super();p(this,"projectViewport");p(this,"page");p(this,"state",q);this.page=e.page,this.projectViewport=e.projectViewport.value,e.projectViewport.subscribe("value",t=>{this.projectViewport=t,this.computePageMeta()}),this.page.subscribe("model",()=>{this.computePageMeta()}),this.computePageMeta()}computePageMeta(){let e=this.doesPageHasViewport("tablet_portrait"),t=this.doesPageHasViewport("phone_portrait"),s=["default",e&&"tablet_portrait",t&&"phone_portrait"].filter(Boolean);this.state={...q,pageId:this.page.model._id,num:this.page.model.num,uri:this.page.model.uri,seo:this.page.model.seo,customSeo:this.page.model.custom_shares,screenshot:this.page.model.screenshot,desktopPageHeight:W(this.page.model,"default"),tabletPageHeight:W(this.page.model,"tablet_portrait"),phonePageHeight:W(this.page.model,"phone_portrait"),currentViewport:this.getPageViewport(this.projectViewport),hasTabletViewport:e,hasPhoneViewport:t,availableViewports:s}}onScaleChange(e){this.state.scale=e,this.state.zoom=M.isFirefox()?1:e,this.state.transform=M.isFirefox()?e:1}getClosestViewport(e){let t=b.dictionary[e].width,s=b.viewports.reduce((r,o,a)=>{let i=T(o.name);if(i!=="viewport_default"){let n=this.page.model[i];if(!n||!n.enabled)return r}return Math.abs(o.width-t)<=Math.abs(b.viewports[r].width-t)?a:r},0);return b.viewports[s].name}doesPageHasViewport(e){let t=T(e);return t==="viewport_default"?!this.page.model.hidden:t in this.page.model&&!!this.page.model[t]?.enabled}getPageViewport(e){return!e||e==="default"||this.doesPageHasViewport(e)?e:this.getClosestViewport(e)}}});function se(m){return F(m)?m.code.length>0:!0}var Y,Ue,Be,Ne,ne=u(()=>{"use strict";E();U();B();N();j();w();re();X();oe();Q();H();Y=class extends c{constructor(e){super();p(this,"project");p(this,"triggersStore");p(this,"animationsStore");p(this,"zIndexStore");p(this,"model");p(this,"meta");p(this,"element");p(this,"widgets");this.project=e.project,this.triggersStore=this.detach(new I),this.animationsStore=this.detach(new R),this.zIndexStore=this.detach(new S),this.model=e.page,this.element=this.detach(new Z),this.meta=new V({page:this,projectViewport:e.project.projectViewport}),this.widgets=this.createWidgets(this.model.widgets),this.zIndexStore.init(Object.values(this.widgets).flat())}createWidgets(e=[]){let t=n=>({...n,pid:this.model._id}),s=h(this.project.model.globalWidgets||[]).map(t),r=h(e).map(t),o=f([...r,...s],n=>n._id),a=this.getWidgetsRenderList(o),i={topFixed:[],backFixed:[],regular:[]};a.background&&(i.background=this.createWidget(a.background));for(let n of a.topFixed)i.topFixed.push(this.createWidget(n));for(let n of a.backFixed)i.backFixed.push(this.createWidget(n));for(let n of a.regular)i.regular.push(this.createWidget(n));return i}createWidget(e){return this.detach(new k({pageMeta:this.meta,project:this.project,triggersStore:this.triggersStore,animationsStore:this.animationsStore,zIndexStore:this.zIndexStore,widget:e}))}setWidgets(e){this.model.widgets=e,this.widgets=this.createWidgets(e)}getWidgetsRenderList(e=[]){if(!e||!e.length)return{regular:[],topFixed:[],backFixed:[]};let t,s=[],r=[],o=[],a=x.reduce((i,n)=>(i[n]=1/0,i),{});for(let i of e)if(se(i))if(C(i))t=i;else{if(i.is_above)continue;for(let n of x){let g=k.getWidgetViewportData(i,n,this.model._id);g&&(g.fixed_position?(o.push(h(i)),r.push(h(i))):(s.push(i),a[n]=Math.min(a[n],g.z)))}}for(let i of x)a[i]===1/0&&(a[i]=0);s=f(s,i=>i._id),o=f(o,i=>i._id),r=f(r,i=>i._id);for(let i of o)v(i,(n,g)=>{n&&n.z>=a[g]&&(n.hidden=!0)});for(let i of r)v(i,(n,g)=>{n&&n.z<a[g]&&(n.hidden=!0)});return{background:t,regular:y(s),topFixed:y(r),backFixed:y(o)}}},{useSnapshot:Ue,useProxy:Be,Provider:Ne}=c.createContext()});export{I as a,U as b,R as c,B as d,S as e,N as f,Y as g,Ue as h,Ne as i,ne as j};
