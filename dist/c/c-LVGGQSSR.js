import{A as _,D as k,G as oe,c as d,d as w,e as A,f as D,t as te,v as Z,w as ie,x as T,y as W}from"https://st-p.rmcdn.net/c9a51d26/dist/c/c-CRTDZU4B.js";import{a as L,b as Q}from"https://st-p.rmcdn.net/c9a51d26/dist/c/c-U5MTH4YD.js";import{a as O,b as ee}from"https://st-p.rmcdn.net/c9a51d26/dist/c/c-YMBEYHON.js";import{m as C,o as z,s as K}from"https://st-p.rmcdn.net/c9a51d26/dist/c/c-Y4VJV6XC.js";import{c as y,k as F,o as H}from"https://st-p.rmcdn.net/c9a51d26/dist/c/c-OEHWGD2O.js";import{A as j,g as h,h as G,z as f}from"https://st-p.rmcdn.net/c9a51d26/dist/c/c-XPZGRGRJ.js";import{h as x,m as M,n as b,o as E}from"https://st-p.rmcdn.net/c9a51d26/dist/c/c-4VWUTGLK.js";import{a as v,b as J}from"https://st-p.rmcdn.net/c9a51d26/dist/c/c-EOLHP4MS.js";import{a as u,f as p}from"https://st-p.rmcdn.net/c9a51d26/dist/c/c-2LNZKOQK.js";var R,U=u(()=>{"use strict";ee();w();H();R=class extends d{constructor(){super();p(this,"triggersState",{});p(this,"triggersElements",{})}bindTriggerElement(e,t){this.triggersElements[e]=this.detach(t),this.bindTriggerCallback(e)}bindTriggerCallback(e){let t=this.triggersState[e]||{},r=this.triggersElements[e];if(r)for(let s in t){let o=t[s];o&&(typeof o.unbind=="function"&&o.unbind(),o.unbind=F({element:r,events:o.events,callback:o.callback}))}}addTriggerCallback({responderWidgetId:e,triggerWidgetIds:t=[],events:r,callback:s}){let o=O();for(let n of t){let i=`${e}-${o}`;n in this.triggersState||(this.triggersState[n]={}),this.triggersState[n][i]={events:r,callback:s},this.bindTriggerCallback(n)}}isWidgetTrigger(e){return e in this.triggersState}}});var I,B=u(()=>{"use strict";j();w();te();Q();I=class extends d{constructor(){super();p(this,"animations",{});p(this,"groupRects",{});p(this,"groupState",{})}getAnimationsGroups(e){let t={},r=G(Object.values(e).map(o=>o.animations).flat(),"UUID"),s=Object.entries(e);for(let[o,n]of s)for(let i of n.animations)r[i.UUID]>1&&(t[i.UUID]=[...t[i.UUID]||[],{widgetId:o,rect:n.rect}]);return t}getAnimationsGroupsRects(e){let t={},r=Object.keys(e);for(let s of r){let o=e[s].map(g=>{let $=this.animations[g.widgetId].transforms.rotation?.angle??0;return L.rotateBox(g.rect,$)}),n=Math.min(...o.map(g=>g.top)),i=Math.min(...o.map(g=>g.left)),a=Math.max(...o.map(g=>g.top+g.height)),l=Math.max(...o.map(g=>g.left+g.width))-i,Y=a-n;t[s]={top:n,left:i,width:l,height:Y}}return t}createGroupsState(e,t){let r={...e};for(let s in t){r[s]=r[s]||{};for(let o of t[s])o.widgetId in r[s]||(r[s][o.widgetId]=!1)}return r}addWidget({widgetId:e,animations:t,rect:r,rotation:s,flipY:o,flipX:n}){this.animations[e]={rect:r,animations:t,transforms:{flipX:n,flipY:o,rotation:A(s),invertedRotation:A((s||0)*-1)}},this.recalculateRectsStates()}recalculateRectsStates(){let e=this.getAnimationsGroups(this.animations),t=this.getAnimationsGroupsRects(e),r=this.createGroupsState(this.groupState,e);this.groupRects=t,this.groupState=r}updateWidgetRect(e,t){this.animations[e].rect=t,this.recalculateRectsStates()}getAnimationsGroupRect(e){return e in this.groupRects?this.groupRects[e]:null}getAnimationsGroupOrigin(e,t){if(e in this.groupRects&&t in this.animations){let r=this.animations[t],s=r.transforms,o=r.rect,n=this.groupRects[e],i={x:o.left-n.left,y:o.top-n.top},a={x:n.width/2,y:n.height/2},c={x:a.x-i.x,y:a.y-i.y},l=D({rotation:s.invertedRotation,point:c,origin:{...o,left:0,top:0}});return s.flipX&&(l.x=o.width-l.x),s.flipY&&(l.y=o.height-l.y),l}return null}getGroupState(e){return e in this.groupState?Object.values(this.groupState[e]).some(Boolean):null}updateGroupState(e,t,r,s=!1){if(e in this.groupState)if(this.groupState[e]=this.groupState[e]||{},s)for(let o in this.groupState[e])this.groupState[e][o]=r;else this.groupState[e][t]=r}getAnimationsWidgetRect(e){return this.animations[e]?.rect||null}}});var S,N=u(()=>{"use strict";w();S=class extends d{constructor(){super();p(this,"zIndexes",{})}init(e){for(let t of e)typeof t.model.z=="number"&&this.setZIndex(t.model._id,t.model.z),t.subscribe("model.z",()=>{typeof t.model.z=="number"&&this.setZIndex(t.model._id,t.model.z)})}getTopmostZIndex(){return Math.max(...Object.values(this.zIndexes))}setZIndex(e,t){typeof t=="number"&&this.zIndexes[e]!==t&&(this.zIndexes[e]=t)}}});var re,V,q=u(()=>{"use strict";w();E();J();_();_();re={pageId:"",scale:1,zoom:1,transform:1,num:0,availableViewports:[],currentViewport:"default",hasTabletViewport:!1,hasPhoneViewport:!1,screenshot:"",desktopPageHeight:0,tabletPageHeight:0,phonePageHeight:0},V=class extends d{constructor(e){super();p(this,"projectViewport");p(this,"page");p(this,"state",re);this.page=e.page,this.projectViewport=e.projectViewport.value,e.projectViewport.subscribe("value",t=>{this.projectViewport=t,this.computePageMeta()}),this.page.subscribe("model",()=>{this.computePageMeta()}),this.computePageMeta()}computePageMeta(){let e=this.doesPageHasViewport("tablet_portrait"),t=this.doesPageHasViewport("phone_portrait"),r=["default",e&&"tablet_portrait",t&&"phone_portrait"].filter(Boolean);this.state={...this.state,pageId:this.page.model._id,num:this.page.model.num,uri:this.page.model.uri,seo:this.page.model.seo,customSeo:this.page.model.custom_shares,screenshot:this.page.model.screenshot,desktopPageHeight:W(this.page.model,"default"),tabletPageHeight:W(this.page.model,"tablet_portrait"),phonePageHeight:W(this.page.model,"phone_portrait"),currentViewport:this.getPageViewport(this.projectViewport),hasTabletViewport:e,hasPhoneViewport:t,availableViewports:r}}onScaleChange(e){this.state.scale=e,this.state.zoom=v.isFirefox()?1:e,this.state.transform=v.isFirefox()?e:1}getClosestViewport(e){let t=b.dictionary[e].width,r=b.viewports.reduce((s,o,n)=>{let i=T(o.name);if(i!=="viewport_default"){let a=this.page.model[i];if(!a||!a.enabled)return s}return Math.abs(o.width-t)<=Math.abs(b.viewports[s].width-t)?n:s},0);return b.viewports[r].name}doesPageHasViewport(e){let t=T(e);return t==="viewport_default"?!this.page.model.hidden:t in this.page.model&&!!this.page.model[t]?.enabled}getPageViewport(e){return!e||e==="default"||this.doesPageHasViewport(e)?e:this.getClosestViewport(e)}}});function se(m){return z(m)?m.code.length>0:!0}var X,Ue,Be,Ne,ne=u(()=>{"use strict";E();U();B();N();j();w();oe();q();ie();K();H();X=class extends d{constructor(e){super();p(this,"project");p(this,"triggersStore");p(this,"animationsStore");p(this,"zIndexStore");p(this,"model");p(this,"meta");p(this,"element");p(this,"widgets");this.project=e.project,this.triggersStore=this.detach(new R),this.animationsStore=this.detach(new I),this.zIndexStore=this.detach(new S),this.model=e.page,this.element=this.detach(new Z),this.meta=new V({page:this,projectViewport:e.project.projectViewport}),this.widgets=this.createWidgets(this.model.widgets),this.zIndexStore.init(Object.values(this.widgets).flat())}createWidgets(e=[]){let t=a=>({...a,pid:this.model._id}),r=h(this.project.model.globalWidgets||[]).map(t),s=h(e).map(t),o=f([...s,...r],a=>a._id),n=this.getWidgetsRenderList(o),i={topFixed:[],backFixed:[],regular:[]};n.background&&(i.background=this.createWidget(n.background));for(let a of n.topFixed)i.topFixed.push(this.createWidget(a));for(let a of n.backFixed)i.backFixed.push(this.createWidget(a));for(let a of n.regular)i.regular.push(this.createWidget(a));return i}createWidget(e){return this.detach(new k({pageMeta:this.meta,project:this.project,triggersStore:this.triggersStore,animationsStore:this.animationsStore,zIndexStore:this.zIndexStore,widget:e}))}setWidgets(e){this.model.widgets=e,this.widgets=this.createWidgets(e),this.zIndexStore.init(Object.values(this.widgets).flat())}getWidgetsRenderList(e=[]){if(!e||!e.length)return{regular:[],topFixed:[],backFixed:[]};let t,r=[],s=[],o=[],n=x.reduce((i,a)=>(i[a]=1/0,i),{});for(let i of e)if(se(i))if(C(i))t=i;else{if(i.is_above)continue;for(let a of x){let c=k.getWidgetViewportData(i,a,this.model._id);c&&(c.fixed_position?(o.push(h(i)),s.push(h(i))):(r.push(i),n[a]=Math.min(n[a],c.z)))}}for(let i of x)n[i]===1/0&&(n[i]=0);r=f(r,i=>i._id),o=f(o,i=>i._id),s=f(s,i=>i._id);for(let i of o)M(i,(a,c)=>{a&&a.z>=n[c]&&(a.hidden=!0)});for(let i of s)M(i,(a,c)=>{a&&a.z<n[c]&&(a.hidden=!0)});return{background:t,regular:y(r),topFixed:y(s),backFixed:y(o)}}},{useSnapshot:Ue,useProxy:Be,Provider:Ne}=d.createContext()});export{R as a,U as b,I as c,B as d,S as e,N as f,X as g,Ue as h,Ne as i,ne as j};
